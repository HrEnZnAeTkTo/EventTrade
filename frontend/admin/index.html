<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventTrade - Управление</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.4/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .admin-app {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #4c9c9f 0%, #25777a 20%);
            color: white;
            flex-shrink: 0;
            position: relative;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 16px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 35px;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.2);
            border-right: 3px solid white;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .header-left {
            flex: 1;
        }

        .header-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #333;
        }

        .header-subtitle {
            color: #666;
            margin-top: 5px;
        }

        .content {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
        }

        .card-content {
            padding: 25px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 2px;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-new {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-in-delivery {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-completed {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .badge-paid {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .badge-pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 25px;
        }

        .error-message {
            background: #fee;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #fecaca;
        }

        .success-message {
            background: #f0fff4;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #9ae6b4;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .filter-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .filter-item select,
        .filter-item input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .chat-panel {
            max-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            max-height: 300px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            position: relative;
        }

        .chat-message.reply {
            border-left: 4px solid #667eea;
            margin-left: 20px;
        }

        .message-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-actions {
            display: flex;
            gap: 5px;
        }

        .message-action {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .message-action:hover {
            background: #e2e8f0;
        }

        .reply-to {
            background: #e3f2fd;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 5px;
            color: #1976d2;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .reply-preview {
            background: #f0f8ff;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
            border-left: 3px solid #667eea;
        }

        .reply-cancel {
            float: right;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .admin-app {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const API_BASE = window.location.protocol + '//' + window.location.hostname + ':3000/api';

        function AdminApp() {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(localStorage.getItem('admin_token'));
            const [activeSection, setActiveSection] = useState('dashboard');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            // Data states
            const [orders, setOrders] = useState([]);
            const [products, setProducts] = useState([]);
            const [tents, setTents] = useState([]);
            const [users, setUsers] = useState([]);
            const [messages, setMessages] = useState([]);
            const [inventoryRequests, setInventoryRequests] = useState([]);

            useEffect(() => {
                if (token) {
                    fetchUserData();
                    fetchAllData();
                    
                    // Poll for updates every 30 seconds
                    const interval = setInterval(fetchAllData, 30000);
                    return () => clearInterval(interval);
                }
            }, [token]);

            const fetchWithAuth = async (url, options = {}) => {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        ...options.headers,
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return null;
                }
                
                return response;
            };

            const fetchUserData = async () => {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    setUser(payload);
                } catch (err) {
                    logout();
                }
            };

            const fetchAllData = async () => {
                try {
                    await Promise.all([
                        fetchOrders(),
                        fetchProducts(),
                        fetchTents(),
                        fetchMessages(),
                        fetchInventoryRequests()
                    ]);
                } catch (err) {
                    console.error('Error fetching data:', err);
                }
            };

            const fetchOrders = async () => {
                try {
                    const response = await fetchWithAuth(`${API_BASE}/orders`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setOrders(data);
                    }
                } catch (err) {
                    console.error('Error fetching orders:', err);
                }
            };

            const fetchProducts = async () => {
                try {
                    const response = await fetchWithAuth(`${API_BASE}/products`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setProducts(data);
                    }
                } catch (err) {
                    console.error('Error fetching products:', err);
                }
            };

            const fetchTents = async () => {
                try {
                    const response = await fetchWithAuth(`${API_BASE}/tents`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setTents(data);
                    }
                } catch (err) {
                    console.error('Error fetching tents:', err);
                }
            };

            const fetchMessages = async () => {
                try {
                    const response = await fetchWithAuth(`${API_BASE}/messages`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setMessages(data);
                    }
                } catch (err) {
                    console.error('Error fetching messages:', err);
                }
            };

            const fetchInventoryRequests = async () => {
                try {
                    const response = await fetchWithAuth(`${API_BASE}/inventory-requests`);
                    if (response && response.ok) {
                        const data = await response.json();
                        setInventoryRequests(data);
                    }
                } catch (err) {
                    console.error('Error fetching inventory requests:', err);
                }
            };

            const login = async (username, password) => {
                setLoading(true);
                setError('');

                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        if (data.user.role === 'admin' || data.user.role === 'operator') {
                            setToken(data.token);
                            setUser(data.user);
                            localStorage.setItem('admin_token', data.token);
                        } else {
                            setError('Недостаточно прав для доступа');
                        }
                    } else {
                        setError(data.error || 'Ошибка входа');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const logout = () => {
                setToken(null);
                setUser(null);
                localStorage.removeItem('admin_token');
                setOrders([]);
                setProducts([]);
                setTents([]);
                setMessages([]);
                setInventoryRequests([]);
                setError('');
                setSuccess('');
            };

            // Clear messages helper
            const clearMessages = () => {
                setError('');
                setSuccess('');
            };

            if (!token) {
                return <LoginForm onLogin={login} loading={loading} error={error} />;
            }

            const stats = {
                totalOrders: orders.length,
                newOrders: orders.filter(o => o.status === 'new').length,
                inDelivery: orders.filter(o => o.status === 'in_delivery').length,
                completedOrders: orders.filter(o => o.status === 'completed').length,
                totalRevenue: orders.reduce((sum, o) => sum + parseFloat(o.total_amount || 0), 0),
                lowStockProducts: products.filter(p => p.stock_quantity < 50).length,
                totalTents: tents.length,
                activeTents: tents.filter(t => t.is_active !== false).length
            };

            return (
                <div className="admin-app">
                    <Sidebar 
                        activeSection={activeSection}
                        onSectionChange={(section) => {
                            setActiveSection(section);
                            clearMessages();
                        }}
                        user={user}
                        onLogout={logout}
                    />
                    
                    <div className="main-content">
                        <Header 
                            title={getSectionTitle(activeSection)}
                            user={user}
                            onLogout={logout}
                        />
                        
                        <div className="content">
                            {error && <div className="error-message">{error}</div>}
                            {success && <div className="success-message">{success}</div>}

                            {activeSection === 'dashboard' && (
                                <Dashboard stats={stats} orders={orders} />
                            )}
                            
                            {activeSection === 'orders' && (
                                <OrdersSection 
                                    orders={orders}
                                    onRefresh={fetchOrders}
                                />
                            )}
                            
                            {activeSection === 'products' && (
                                <ProductsSection 
                                    products={products}
                                    onRefresh={fetchProducts}
                                    fetchWithAuth={fetchWithAuth}
                                    setError={setError}
                                    setSuccess={setSuccess}
                                />
                            )}
                            
                            {activeSection === 'tents' && (
                                <TentsSection 
                                    tents={tents}
                                    onRefresh={fetchTents}
                                    fetchWithAuth={fetchWithAuth}
                                    setError={setError}
                                    setSuccess={setSuccess}
                                />
                            )}
                            
                            {activeSection === 'chat' && (
                                <ChatSection 
                                    messages={messages}
                                    onRefresh={fetchMessages}
                                    fetchWithAuth={fetchWithAuth}
                                    setError={setError}
                                    setSuccess={setSuccess}
                                    currentUser={user}
                                />
                            )}
                            
                            {activeSection === 'inventory' && (
                                <InventorySection 
                                    requests={inventoryRequests}
                                    onRefresh={fetchInventoryRequests}
                                    fetchWithAuth={fetchWithAuth}
                                    setError={setError}
                                    setSuccess={setSuccess}
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function getSectionTitle(section) {
            const titles = {
                dashboard: 'Панель управления',
                orders: 'Управление заказами',
                products: 'Управление товарами',
                tents: 'Управление палатками',
                chat: 'Чат с курьерами',
                inventory: 'Запросы пополнения'
            };
            return titles[section] || 'Панель управления';
        }

        function LoginForm({ onLogin, loading, error }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(username, password);
            };

            return (
                <div style={{ 
                    minHeight: '100vh', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                }}>
                    <div style={{ 
                        background: 'white', 
                        padding: '40px', 
                        borderRadius: '12px',
                        boxShadow: '0 10px 25px rgba(0,0,0,0.2)',
                        width: '100%',
                        maxWidth: '400px'
                    }}>
                        <h1 style={{ textAlign: 'center', marginBottom: '30px', color: '#333' }}>
                            Админ-панель
                        </h1>
                        
                        {error && <div className="error-message">{error}</div>}
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Логин</label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    placeholder="Введите логин"
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label>Пароль</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Введите пароль"
                                    required
                                />
                            </div>
                            
                            <button type="submit" className="btn" disabled={loading} style={{ width: '100%' }}>
                                {loading ? 'Вход...' : 'Войти'}
                            </button>
                        </form>
                        
                        <div style={{ marginTop: '20px', fontSize: '14px', color: '#666', textAlign: 'center' }}>
                            Тестовый аккаунт:<br />
                            admin / admin123
                        </div>
                    </div>
                </div>
            );
        }

        function Sidebar({ activeSection, onSectionChange, user, onLogout }) {
            const menuItems = [
                { id: 'dashboard', label: 'Панель управления' },
                { id: 'orders', label: 'Заказы' },
                { id: 'products', label: 'Товары' },
                { id: 'tents', label: 'Палатки' },
                { id: 'chat', label: 'Чат' },
                { id: 'inventory', label: 'Запросы' }
            ];

            return (
                <div className="sidebar">
                    <div className="sidebar-header">
                        <h1>EventTrade</h1>
                        <div>Админ панель</div>
                    </div>
                    
                    <nav className="sidebar-nav">
                        {menuItems.map(item => (
                            <button
                                key={item.id}
                                className={`nav-item ${activeSection === item.id ? 'active' : ''}`}
                                onClick={() => onSectionChange(item.id)}
                            >
                                {item.label}
                            </button>
                        ))}
                    </nav>
                    
                    <div style={{ position: 'absolute', bottom: '20px', left: '20px', right: '20px' }}>
                        <div style={{ fontSize: '14px', marginBottom: '10px', opacity: 0.8 }}>
                            {user?.username} ({user?.role})
                        </div>
                        <button className="btn btn-danger" onClick={onLogout} style={{ width: '100%' }}>
                            Выйти
                        </button>
                    </div>
                </div>
            );
        }

        function Header({ title, user, onLogout }) {
            return (
                <div className="header">
                    <div className="header-left">
                        <div className="header-title">{title}</div>
                        <div className="header-subtitle">
                            {new Date().toLocaleDateString('ru-RU', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        function Dashboard({ stats, orders }) {
            const recentOrders = orders.slice(0, 5);

            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-icon">📦</div>
                            <div className="stat-number">{stats.totalOrders}</div>
                            <div className="stat-label">Всего заказов</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-icon">🆕</div>
                            <div className="stat-number">{stats.newOrders}</div>
                            <div className="stat-label">Новые заказы</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-icon">🚚</div>
                            <div className="stat-number">{stats.inDelivery}</div>
                            <div className="stat-label">В доставке</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-icon">✅</div>
                            <div className="stat-number">{stats.completedOrders}</div>
                            <div className="stat-label">Выполнено</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-icon">💰</div>
                            <div className="stat-number">{stats.totalRevenue.toFixed(0)} ₽</div>
                            <div className="stat-label">Общая выручка</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-icon">🏕️</div>
                            <div className="stat-number">{stats.activeTents} / {stats.totalTents}</div>
                            <div className="stat-label">Активные палатки</div>
                        </div>
                    </div>

                    <div className="card">
                        <div className="card-header">
                            <div className="card-title">Последние заказы</div>
                        </div>
                        <div className="card-content">
                            {recentOrders.length === 0 ? (
                                <p>Заказов пока нет</p>
                            ) : (
                                <table className="table">
                                    <thead>
                                        <tr>
                                            <th>№ заказа</th>
                                            <th>Палатка</th>
                                            <th>Сумма</th>
                                            <th>Статус</th>
                                            <th>Время</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {recentOrders.map(order => (
                                            <tr key={order.id}>
                                                <td>#{order.id}</td>
                                                <td>{order.tent_number}</td>
                                                <td>{order.total_amount} ₽</td>
                                                <td>
                                                    <span className={`badge badge-${order.status.replace('_', '-')}`}>
                                                        {getStatusText(order.status)}
                                                    </span>
                                                </td>
                                                <td>{new Date(order.created_at).toLocaleString('ru-RU')}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function OrdersSection({ orders, onRefresh }) {
            const [filterStatus, setFilterStatus] = useState('');
            const [filterTent, setFilterTent] = useState('');

            const filteredOrders = orders.filter(order => {
                return (!filterStatus || order.status === filterStatus) &&
                       (!filterTent || order.tent_number.toLowerCase().includes(filterTent.toLowerCase()));
            });

            return (
                <div className="card">
                    <div className="card-header">
                        <div className="card-title">Все заказы ({filteredOrders.length})</div>
                        <button className="btn" onClick={onRefresh} style={{ marginLeft: '5px' }}>
                            Обновить
                        </button>
                    </div>
                    
                    <div className="card-content">
                        <div className="filters">
                            <div className="filter-item">
                                <label>Статус</label>
                                <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}>
                                    <option value="">Все статусы</option>
                                    <option value="new">Новые</option>
                                    <option value="in_delivery">В доставке</option>
                                    <option value="completed">Завершенные</option>
                                </select>
                            </div>
                            
                            <div className="filter-item">
                                <label>Палатка</label>
                                <input
                                    type="text"
                                    placeholder="Поиск по номеру палатки"
                                    value={filterTent}
                                    onChange={(e) => setFilterTent(e.target.value)}
                                />
                            </div>
                        </div>

                        <table className="table">
                            <thead>
                                <tr>
                                    <th>№</th>
                                    <th>Палатка</th>
                                    <th>Товары</th>
                                    <th>Сумма</th>
                                    <th>Статус</th>
                                    <th>Оплата</th>
                                    <th>Курьер</th>
                                    <th>Время</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredOrders.map(order => (
                                    <tr key={order.id}>
                                        <td>#{order.id}</td>
                                        <td>{order.tent_number}</td>
                                        <td>
                                            {order.items && order.items[0] ? (
                                                <div style={{ fontSize: '12px' }}>
                                                    {order.items.map((item, i) => (
                                                        <div key={i}>
                                                            {item.product_name} × {item.quantity}
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : 'Загрузка...'}
                                        </td>
                                        <td>{order.total_amount} ₽</td>
                                        <td>
                                            <span className={`badge badge-${order.status.replace('_', '-')}`}>
                                                {getStatusText(order.status)}
                                            </span>
                                        </td>
                                        <td>
                                            <span className={`badge badge-${order.payment_status || 'pending'}`}>
                                                {getPaymentStatusText(order.payment_status)}
                                            </span>
                                        </td>
                                        <td>{order.courier_name || '—'}</td>
                                        <td>{new Date(order.created_at).toLocaleString('ru-RU')}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function ProductsSection({ products, onRefresh, fetchWithAuth, setError, setSuccess }) {
            const [showAddModal, setShowAddModal] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false);
            const [showStockModal, setShowStockModal] = useState(false);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [loading, setLoading] = useState(false);

            const addProduct = async (productData) => {
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/products`, {
                        method: 'POST',
                        body: JSON.stringify(productData)
                    });

                    if (response && response.ok) {
                        setSuccess('Товар добавлен успешно');
                        onRefresh();
                        setShowAddModal(false);
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при добавлении товара');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const updateProduct = async (productData) => {
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/products/${selectedProduct.id}`, {
                        method: 'PUT',
                        body: JSON.stringify(productData)
                    });

                    if (response && response.ok) {
                        setSuccess('Товар обновлен успешно');
                        onRefresh();
                        setShowEditModal(false);
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при обновлении товара');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const updateStock = async (operation, amount, newValue) => {
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/products/${selectedProduct.id}/stock`, {
                        method: 'PATCH',
                        body: JSON.stringify({ operation, amount, newValue })
                    });

                    if (response && response.ok) {
                        setSuccess('Количество товара обновлено');
                        onRefresh();
                        setShowStockModal(false);
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при обновлении количества');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const toggleProductStatus = async (productId, isActive) => {
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/products/${productId}/toggle`, {
                        method: 'PATCH'
                    });

                    if (response && response.ok) {
                        const data = await response.json();
                        setSuccess(data.message);
                        onRefresh();
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при изменении статуса товара');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const deleteProduct = async (productId) => {
                if (!confirm('Вы уверены, что хотите ПОЛНОСТЬЮ УДАЛИТЬ этот товар? Это действие нельзя отменить!')) {
                    return;
                }
                
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/products/${productId}`, {
                        method: 'DELETE'
                    });

                    if (response && response.ok) {
                        setSuccess('Товар удален');
                        onRefresh();
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при удалении товара');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <div className="card">
                        <div className="card-header">
                            <div className="card-title">Товары на складе</div>
                            <div>
                                <button className="btn" onClick={() => setShowAddModal(true)} style={{ marginLeft: '10px' }}>
                                    Добавить товар
                                </button>
                                <button className="btn" onClick={onRefresh} style={{ marginLeft: '10px' }}>
                                    Обновить
                                </button>
                            </div>
                        </div>
                        
                        <div className="card-content">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Описание</th>
                                        <th>Цена</th>
                                        <th>Остаток</th>
                                        <th>Статус</th>
                                        <th>Видимость</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {products.map(product => (
                                        <tr key={product.id} style={{ 
                                            opacity: product.is_active === false ? 0.6 : 1 
                                        }}>
                                            <td><strong>{product.name}</strong></td>
                                            <td>{product.description}</td>
                                            <td>{product.price} ₽</td>
                                            <td>
                                                <span style={{
                                                    color: product.stock_quantity === 0 ? '#e53e3e' :
                                                           product.stock_quantity < 50 ? '#d69e2e' : '#2d3748'
                                                }}>
                                                    {product.stock_quantity} шт.
                                                </span>
                                            </td>
                                            <td>
                                                {product.stock_quantity === 0 ? (
                                                    <span className="badge" style={{ background: '#fed7d7', color: '#9b2c2c' }}>
                                                        Нет в наличии
                                                    </span>
                                                ) : product.stock_quantity < 50 ? (
                                                    <span className="badge badge-pending">
                                                        Мало товара
                                                    </span>
                                                ) : (
                                                    <span className="badge badge-completed">
                                                        В наличии
                                                    </span>
                                                )}
                                            </td>
                                            <td>
                                                {product.is_active === false ? (
                                                    <span className="badge" style={{ background: '#dfdfdf', color: '#9b2c2c' }}>
                                                        Скрыт
                                                    </span>
                                                ) : (
                                                    <span className="badge badge-completed">
                                                        Виден
                                                    </span>
                                                )}
                                            </td>
                                            <td>
                                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '5px' }}>
                                                    <button 
                                                        className="btn btn-sm"
                                                        onClick={() => {
                                                            setSelectedProduct(product);
                                                            setShowEditModal(true);
                                                        }}
                                                    >
                                                        Изменить товар
                                                    </button>
                                                    <button 
                                                        className="btn btn-sm btn-secondary"
                                                        onClick={() => {
                                                            setSelectedProduct(product);
                                                            setShowStockModal(true);
                                                        }}
                                                    >
                                                        Изменить наличие
                                                    </button>
                                                    <button 
                                                        className={`btn btn-sm ${product.is_active === false ? 'btn-success' : 'btn-secondary'}`}
                                                        onClick={() => toggleProductStatus(product.id, product.is_active)}
                                                        disabled={loading}
                                                        title={product.is_active === false ? 'Показать товар' : 'Скрыть товар'}
                                                    >
                                                        {product.is_active === false ? 'Показать' : 'Скрыть'}
                                                    </button>
                                                    <button 
                                                        className="btn btn-sm btn-danger"
                                                        onClick={() => deleteProduct(product.id)}
                                                        disabled={loading}
                                                        title="Удалить товар"
                                                    >
                                                        Удалить товар
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Modals for products (same as before) */}
                    {showAddModal && (
                        <ProductModal
                            title="Добавить новый товар"
                            onSave={addProduct}
                            onClose={() => setShowAddModal(false)}
                            loading={loading}
                        />
                    )}

                    {showEditModal && selectedProduct && (
                        <ProductModal
                            title="Редактировать товар"
                            product={selectedProduct}
                            onSave={updateProduct}
                            onClose={() => setShowEditModal(false)}
                            loading={loading}
                        />
                    )}

                    {showStockModal && selectedProduct && (
                        <StockModal
                            product={selectedProduct}
                            onSave={updateStock}
                            onClose={() => setShowStockModal(false)}
                            loading={loading}
                        />
                    )}
                </div>
            );
        }

        // Enhanced TentsSection with full CRUD
        function TentsSection({ tents, onRefresh, fetchWithAuth, setError, setSuccess }) {
            const [showAddModal, setShowAddModal] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false);
            const [selectedTent, setSelectedTent] = useState(null);
            const [loading, setLoading] = useState(false);

            const addTent = async (tentData) => {
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/tents`, {
                        method: 'POST',
                        body: JSON.stringify(tentData)
                    });

                    if (response && response.ok) {
                        setSuccess('Палатка добавлена успешно');
                        onRefresh();
                        setShowAddModal(false);
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при добавлении палатки');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const updateTent = async (tentData) => {
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/tents/${selectedTent.id}`, {
                        method: 'PUT',
                        body: JSON.stringify(tentData)
                    });

                    if (response && response.ok) {
                        setSuccess('Палатка обновлена успешно');
                        onRefresh();
                        setShowEditModal(false);
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при обновлении палатки');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const toggleTentStatus = async (tentId) => {
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/tents/${tentId}/toggle`, {
                        method: 'PATCH'
                    });

                    if (response && response.ok) {
                        const data = await response.json();
                        setSuccess(data.message);
                        onRefresh();
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при изменении статуса палатки');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const deleteTent = async (tentId) => {
                if (!confirm('Вы уверены, что хотите удалить эту палатку? Убедитесь, что у неё нет активных заказов.')) {
                    return;
                }
                
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/tents/${tentId}`, {
                        method: 'DELETE'
                    });

                    if (response && response.ok) {
                        setSuccess('Палатка удалена');
                        onRefresh();
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при удалении палатки');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <div className="card">
                        <div className="card-header">
                            <div className="card-title">Палатки фестиваля</div>
                            <div>
                                <button className="btn" onClick={() => setShowAddModal(true)} style={{ marginLeft: '10px' }}>
                                    Добавить палатку
                                </button>
                                <button className="btn" onClick={onRefresh} style={{ marginLeft: '10px' }}>
                                    Обновить
                                </button>
                            </div>
                        </div>
                        
                        <div className="card-content">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Номер палатки</th>
                                        <th>Зона</th>
                                        <th>Описание локации</th>
                                        <th>Вместимость</th>
                                        <th>Контакт</th>
                                        <th>QR-код</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {tents.map(tent => (
                                        <tr key={tent.id} style={{ 
                                            opacity: tent.is_active === false ? 0.6 : 1 
                                        }}>
                                            <td><strong>{tent.tent_number}</strong></td>
                                            <td>{tent.zone || '—'}</td>
                                            <td>{tent.location_description || '—'}</td>
                                            <td>{tent.capacity || 4} чел.</td>
                                            <td>
                                                {tent.contact_name && (
                                                    <div style={{ fontSize: '12px' }}>
                                                        <div>{tent.contact_name}</div>
                                                        {tent.contact_phone && <div>{tent.contact_phone}</div>}
                                                    </div>
                                                )}
                                            </td>
                                            <td>
                                                {tent.qr_code && (
                                                    <img 
                                                        src={tent.qr_code} 
                                                        alt="QR код" 
                                                        style={{ width: '40px', height: '40px' }}
                                                    />
                                                )}
                                            </td>
                                            <td>
                                                {tent.is_active === false ? (
                                                    <span className="badge" style={{ background: '#fed7d7', color: '#9b2c2c' }}>
                                                        Скрыта
                                                    </span>
                                                ) : (
                                                    <span className="badge badge-completed">
                                                        Активна
                                                    </span>
                                                )}
                                            </td>
                                            <td>
                                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '5px' }}>
                                                    <button 
                                                        className="btn btn-sm"
                                                        onClick={() => {
                                                            setSelectedTent(tent);
                                                            setShowEditModal(true);
                                                        }}
                                                    >
                                                        Изменить
                                                    </button>
                                                    <button 
                                                        className={`btn btn-sm ${tent.is_active === false ? 'btn-success' : 'btn-secondary'}`}
                                                        onClick={() => toggleTentStatus(tent.id)}
                                                        disabled={loading}
                                                    >
                                                        {tent.is_active === false ? 'Активировать' : 'Скрыть'}
                                                    </button>
                                                    <button 
                                                        className="btn btn-sm btn-danger"
                                                        onClick={() => deleteTent(tent.id)}
                                                        disabled={loading}
                                                        title="Удалить палатку"
                                                    >
                                                        Удалить
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Tent Modals */}
                    {showAddModal && (
                        <TentModal
                            title="Добавить новую палатку"
                            onSave={addTent}
                            onClose={() => setShowAddModal(false)}
                            loading={loading}
                        />
                    )}

                    {showEditModal && selectedTent && (
                        <TentModal
                            title="Редактировать палатку"
                            tent={selectedTent}
                            onSave={updateTent}
                            onClose={() => setShowEditModal(false)}
                            loading={loading}
                        />
                    )}
                </div>
            );
        }

        // Enhanced ChatSection with replies and deletion
        function ChatSection({ messages, onRefresh, fetchWithAuth, setError, setSuccess, currentUser }) {
            const [newMessage, setNewMessage] = useState('');
            const [replyTo, setReplyTo] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim()) return;
                
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/messages`, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            message: newMessage.trim(),
                            receiver_id: null,
                            reply_to_id: replyTo?.id || null
                        })
                    });

                    if (response && response.ok) {
                        setNewMessage('');
                        setReplyTo(null);
                        onRefresh();
                    } else {
                        setError('Ошибка отправки сообщения');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteMessage = async (messageId) => {
                if (!confirm('Удалить это сообщение?')) return;
                
                try {
                    const response = await fetchWithAuth(`${API_BASE}/messages/${messageId}`, {
                        method: 'DELETE'
                    });

                    if (response && response.ok) {
                        onRefresh();
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка удаления сообщения');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                }
            };

            const handleReply = (message) => {
                setReplyTo(message);
            };

            const canDeleteMessage = (message) => {
                return currentUser?.role === 'admin' || 
                       currentUser?.role === 'operator' ||
                       message.sender_id === currentUser?.id;
            };

            return (
                <div className="card">
                    <div className="card-header">
                        <div className="card-title">Чат с курьерами</div>
                        <button className="btn" onClick={onRefresh} style={{ marginLeft: '5px' }}>
                            Обновить
                        </button>
                    </div>
                    
                    <div className="card-content">
                        <div className="chat-panel">
                            <div className="chat-messages">
                                {messages.length === 0 ? (
                                    <p>Сообщений пока нет</p>
                                ) : (
                                    messages.map(message => (
                                        <div 
                                            key={message.id} 
                                            className={`chat-message ${message.reply_to_id ? 'reply' : ''}`}
                                            onDoubleClick={() => handleReply(message)}
                                        >
                                            {message.reply_to_message && (
                                                <div className="reply-to">
                                                    ↳ Ответ на: {message.reply_to_sender}: {message.reply_to_message.substring(0, 50)}...
                                                </div>
                                            )}
                                            <div className="message-header">
                                                <span>
                                                    <strong>{message.sender_name}</strong> • {' '}
                                                    {new Date(message.created_at).toLocaleString('ru-RU')}
                                                </span>
                                                <div className="message-actions">
                                                    <button 
                                                        className="message-action"
                                                        onClick={() => handleReply(message)}
                                                        title="Ответить"
                                                    >
                                                        ↩️
                                                    </button>
                                                    {canDeleteMessage(message) && (
                                                        <button 
                                                            className="message-action"
                                                            onClick={() => handleDeleteMessage(message.id)}
                                                            title="Удалить"
                                                        >
                                                            🗑️
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            <div>{message.message}</div>
                                        </div>
                                    ))
                                )}
                            </div>
                            
                            {replyTo && (
                                <div className="reply-preview">
                                    <button 
                                        className="reply-cancel"
                                        onClick={() => setReplyTo(null)}
                                    >
                                        ✕
                                    </button>
                                    <strong>Ответ на:</strong> {replyTo.sender_name}: {replyTo.message.substring(0, 100)}...
                                </div>
                            )}
                            
                            <form className="chat-input" onSubmit={handleSendMessage}>
                                <input
                                    type="text"
                                    value={newMessage}
                                    onChange={(e) => setNewMessage(e.target.value)}
                                    placeholder={replyTo ? "Напишите ответ..." : "Написать сообщение всем курьерам..."}
                                    maxLength={500}
                                    disabled={loading}
                                />
                                <button type="submit" className="btn" disabled={loading || !newMessage.trim()}>
                                    {loading ? '...' : 'Отправить'}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function InventorySection({ requests, onRefresh, fetchWithAuth, setError, setSuccess }) {
            const [loading, setLoading] = useState(false);

            const approveRequest = async (requestId, approvedQuantity) => {
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/inventory-requests/${requestId}/approve`, {
                        method: 'PATCH',
                        body: JSON.stringify({ approved_quantity: approvedQuantity })
                    });

                    if (response && response.ok) {
                        setSuccess('Запрос одобрен и товар добавлен на склад');
                        onRefresh();
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при одобрении запроса');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            const rejectRequest = async (requestId, reason) => {
                try {
                    setLoading(true);
                    const response = await fetchWithAuth(`${API_BASE}/inventory-requests/${requestId}/reject`, {
                        method: 'PATCH',
                        body: JSON.stringify({ reason })
                    });

                    if (response && response.ok) {
                        setSuccess('Запрос отклонен');
                        onRefresh();
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка при отклонении запроса');
                    }
                } catch (err) {
                    setError('Ошибка сети');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="card">
                    <div className="card-header">
                        <div className="card-title">Запросы пополнения</div>
                        <button className="btn" onClick={onRefresh} style={{ marginLeft: '5px' }}>
                            Обновить
                        </button>
                    </div>
                    
                    <div className="card-content">
                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Курьер</th>
                                    <th>Товар</th>
                                    <th>Количество</th>
                                    <th>Статус</th>
                                    <th>Время запроса</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {requests.map(request => (
                                    <tr key={request.id}>
                                        <td>{request.courier_name}</td>
                                        <td>{request.product_name}</td>
                                        <td>{request.requested_quantity} шт.</td>
                                        <td>
                                            <span className={`badge badge-${request.status}`}>
                                                {request.status === 'pending' ? 'Ожидает' : 
                                                 request.status === 'approved' ? 'Одобрен' : 'Отклонен'}
                                            </span>
                                        </td>
                                        <td>{new Date(request.created_at).toLocaleString('ru-RU')}</td>
                                        <td>
                                            {request.status === 'pending' && (
                                                <div style={{ display: 'flex', gap: '5px' }}>
                                                    <button 
                                                        className="btn btn-sm btn-success"
                                                        onClick={() => {
                                                            const quantity = parseInt(prompt(`Одобрить запрос на ${request.requested_quantity} шт. товара "${request.product_name}"?\n\nВведите количество для одобрения:`, request.requested_quantity));
                                                            if (quantity && quantity > 0) {
                                                                approveRequest(request.id, quantity);
                                                            }
                                                        }}
                                                        disabled={loading}
                                                    >
                                                        ✅ Одобрить
                                                    </button>
                                                    <button 
                                                        className="btn btn-sm btn-danger"
                                                        onClick={() => {
                                                            const reason = prompt('Причина отклонения запроса:', '');
                                                            if (reason !== null) {
                                                                rejectRequest(request.id, reason);
                                                            }
                                                        }}
                                                        disabled={loading}
                                                    >
                                                        ❌ Отклонить
                                                    </button>
                                                </div>
                                            )}
                                            {request.status === 'approved' && request.approved_quantity && (
                                                <span style={{ color: '#2d3748', fontSize: '12px' }}>
                                                    Одобрено: {request.approved_quantity} шт.
                                                </span>
                                            )}
                                            {request.status === 'rejected' && (
                                                <span style={{ color: '#e53e3e', fontSize: '12px' }}>
                                                    Отклонен
                                                </span>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>

                        {requests.length === 0 && (
                            <div style={{ textAlign: 'center', padding: '40px', color: '#666' }}>
                                📋 Нет запросов на пополнение
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Modal Components
        function ProductModal({ title, product, onSave, onClose, loading }) {
            const [formData, setFormData] = useState({
                name: product?.name || '',
                description: product?.description || '',
                price: product?.price || '',
                stock_quantity: product?.stock_quantity || 0
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.name && formData.price) {
                    onSave({
                        ...formData,
                        price: parseFloat(formData.price),
                        stock_quantity: parseInt(formData.stock_quantity) || 0
                    });
                }
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">{title}</div>
                            <button className="modal-close" onClick={onClose}>✕</button>
                        </div>
                        <div className="modal-body">
                            <form onSubmit={handleSubmit}>
                                <div className="form-group">
                                    <label>Название товара *</label>
                                    <input
                                        type="text"
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        required
                                        placeholder="Введите название товара"
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label>Описание</label>
                                    <textarea
                                        value={formData.description}
                                        onChange={(e) => setFormData({...formData, description: e.target.value})}
                                        placeholder="Введите описание товара"
                                        rows="3"
                                        style={{ resize: 'vertical' }}
                                    />
                                </div>
                                
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Цена (₽) *</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            min="0"
                                            value={formData.price}
                                            onChange={(e) => setFormData({...formData, price: e.target.value})}
                                            required
                                            placeholder="0.00"
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label>Количество на складе</label>
                                        <input
                                            type="number"
                                            min="0"
                                            value={formData.stock_quantity}
                                            onChange={(e) => setFormData({...formData, stock_quantity: Math.max(0, parseInt(e.target.value) || 0)})}
                                            placeholder="0"
                                        />
                                    </div>
                                </div>
                                
                                <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                                    <button type="submit" className="btn" disabled={loading}>
                                        {loading ? 'Сохранение...' : 'Сохранить'}
                                    </button>
                                    <button type="button" className="btn btn-secondary" onClick={onClose}>
                                        Отмена
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function TentModal({ title, tent, onSave, onClose, loading }) {
            const [formData, setFormData] = useState({
                tent_number: tent?.tent_number || '',
                location_description: tent?.location_description || '',
                zone: tent?.zone || '',
                capacity: tent?.capacity || 4,
                contact_name: tent?.contact_name || '',
                contact_phone: tent?.contact_phone || '',
                notes: tent?.notes || ''
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.tent_number) {
                    onSave({
                        ...formData,
                        capacity: parseInt(formData.capacity) || 4
                    });
                }
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">{title}</div>
                            <button className="modal-close" onClick={onClose}>✕</button>
                        </div>
                        <div className="modal-body">
                            <form onSubmit={handleSubmit}>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Номер палатки *</label>
                                        <input
                                            type="text"
                                            value={formData.tent_number}
                                            onChange={(e) => setFormData({...formData, tent_number: e.target.value})}
                                            required
                                            placeholder="A-01"
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label>Зона</label>
                                        <input
                                            type="text"
                                            value={formData.zone}
                                            onChange={(e) => setFormData({...formData, zone: e.target.value})}
                                            placeholder="Зона A"
                                        />
                                    </div>
                                </div>
                                
                                <div className="form-group">
                                    <label>Описание локации</label>
                                    <textarea
                                        value={formData.location_description}
                                        onChange={(e) => setFormData({...formData, location_description: e.target.value})}
                                        placeholder="Описание расположения палатки"
                                        rows="2"
                                    />
                                </div>
                                
                                <div className="form-row">
                                    <div className="form-group">
                                        <label>Вместимость (чел.)</label>
                                        <input
                                            type="number"
                                            min="1"
                                            max="20"
                                            value={formData.capacity}
                                            onChange={(e) => setFormData({...formData, capacity: parseInt(e.target.value) || 4})}
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label>Телефон контакта</label>
                                        <input
                                            type="tel"
                                            value={formData.contact_phone}
                                            onChange={(e) => setFormData({...formData, contact_phone: e.target.value})}
                                            placeholder="+7 (999) 123-45-67"
                                        />
                                    </div>
                                </div>
                                
                                <div className="form-group">
                                    <label>Имя контактного лица</label>
                                    <input
                                        type="text"
                                        value={formData.contact_name}
                                        onChange={(e) => setFormData({...formData, contact_name: e.target.value})}
                                        placeholder="Иван Иванов"
                                    />
                                </div>
                                
                                <div className="form-group">
                                    <label>Заметки</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                        placeholder="Дополнительная информация"
                                        rows="2"
                                    />
                                </div>
                                
                                <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                                    <button type="submit" className="btn" disabled={loading}>
                                        {loading ? 'Сохранение...' : 'Сохранить'}
                                    </button>
                                    <button type="button" className="btn btn-secondary" onClick={onClose}>
                                        Отмена
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function StockModal({ product, onSave, onClose, loading }) {
            const [operation, setOperation] = useState('set');
            const [amount, setAmount] = useState('');
            const [newValue, setNewValue] = useState(product.stock_quantity);

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (operation === 'set') {
                    onSave('set', null, Math.max(0, parseInt(newValue) || 0));
                } else {
                    const value = Math.max(0, parseInt(amount) || 0);
                    if (value > 0) {
                        onSave(operation, value, null);
                    }
                }
            };

            const getPreviewValue = () => {
                if (operation === 'set') {
                    return Math.max(0, parseInt(newValue) || 0);
                } else if (operation === 'add') {
                    return product.stock_quantity + (parseInt(amount) || 0);
                } else if (operation === 'subtract') {
                    return Math.max(0, product.stock_quantity - (parseInt(amount) || 0));
                }
                return product.stock_quantity;
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">Изменение количества: {product.name}</div>
                            <button className="modal-close" onClick={onClose}>✕</button>
                        </div>
                        <div className="modal-body">
                            <div style={{ background: '#f7fafc', padding: '15px', borderRadius: '8px', marginBottom: '20px' }}>
                                <strong>Текущее количество:</strong> {product.stock_quantity} шт.
                            </div>

                            <form onSubmit={handleSubmit}>
                                <div className="form-group">
                                    <label>Тип операции</label>
                                    <select 
                                        value={operation} 
                                        onChange={(e) => setOperation(e.target.value)}
                                    >
                                        <option value="set">Установить точное количество</option>
                                        <option value="add">Прибавить к текущему</option>
                                        <option value="subtract">Вычесть из текущего</option>
                                    </select>
                                </div>

                                {operation === 'set' ? (
                                    <div className="form-group">
                                        <label>Новое количество</label>
                                        <input
                                            type="number"
                                            min="0"
                                            value={newValue}
                                            onChange={(e) => setNewValue(Math.max(0, parseInt(e.target.value) || 0))}
                                            placeholder="0"
                                            required
                                        />
                                    </div>
                                ) : (
                                    <div className="form-group">
                                        <label>
                                            Количество для {operation === 'add' ? 'добавления' : 'вычитания'}
                                        </label>
                                        <input
                                            type="number"
                                            min="1"
                                            value={amount}
                                            onChange={(e) => setAmount(e.target.value)}
                                            placeholder="0"
                                            required
                                        />
                                    </div>
                                )}

                                <div style={{ 
                                    background: '#e6fffa', 
                                    padding: '15px', 
                                    borderRadius: '8px', 
                                    marginBottom: '20px',
                                    border: '1px solid #38b2ac'
                                }}>
                                    <strong>Итоговое количество:</strong> {getPreviewValue()} шт.
                                </div>
                                
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button type="submit" className="btn" disabled={loading}>
                                        {loading ? 'Обновление...' : 'Применить'}
                                    </button>
                                    <button type="button" className="btn btn-secondary" onClick={onClose}>
                                        Отмена
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function getStatusText(status) {
            const statuses = {
                'new': 'Новый',
                'in_delivery': 'В доставке',
                'completed': 'Завершен'
            };
            return statuses[status] || status;
        }

        function getPaymentStatusText(status) {
            const statuses = {
                'pending': 'Ожидает',
                'paid': 'Оплачен',
                'failed': 'Ошибка'
            };
            return statuses[status] || 'Ожидает';
        }

        ReactDOM.render(<AdminApp />, document.getElementById('root'));
    </script>
</body>
</html>